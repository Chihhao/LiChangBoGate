
## 一次性驗證，簡化讀取權限

1.  **一次性驗證**：使用者一旦成功登入主畫面，就代表他已通過白名單驗證，後續操作（按按鈕）不再重複檢查。
2.  **簡化讀取權限**：開放白名單的查詢權限給所有登入者，以加速前端的驗證過程。

這是一個很棒的優化方向。為了達成這個目標，我們需要修改**前端**的登入流程和**後端資料庫**的安全規則。

以下是您需要進行修改的項目分析。

---

### **針對需求 1：登入後即代表授權，按鈕操作不再重複驗證**

這個需求需要修改兩個地方：前端的 `script.js` 和後端的 `control-door/index.ts`。

**A. 修改前端 `script.js`：在登入成功後，立刻進行白名單驗證**

*   **目前的邏輯**：使用者透過 Google 登入後，前端**沒有**檢查他是否在白名單內，就直接顯示操作按鈕。權限檢查完全依賴後端。
*   **要修改成的邏輯**：使用者透過 Google 登入後，前端**必須立刻查詢 `whitelist` 資料表**。
    *   如果使用者的 email 在白名單內，才顯示操作按鈕 (`control-view`)。
    *   如果不在，就顯示一個「權限不足」的訊息，即使登入成功也不給操作。

*   **需要修改的檔案**： `script.js`
*   **具體作法**：
    1.  在 `onLoginSuccess(user)` 函式中，新增一段程式碼。
    2.  這段程式碼會使用 `supabaseClient` 去 `select` `whitelist` 資料表，查詢當前登入者的 email 是否存在。
    3.  根據查詢結果，來決定要顯示 `control-view` 還是顯示錯誤訊息。

**B. 修改後端 `control-door/index.ts`：移除每次操作時的白名單驗證**

*   **目前的邏輯**：每次使用者按下「上升」、「停止」或「下降」按鈕時，後端的雲端函式都會去資料庫裡檢查一次他的 email 是否在白名單內。
*   **要修改成的邏輯**：移除這個檢查步驟。因為經過 A 步驟的修改後，能呼叫這個函式的使用者，必定是已經通過驗證的。

*   **需要修改的檔案**： `supabase/functions/control-door/index.ts`
*   **具體作法**：
    1.  找到檔案中檢查白名單的那一段程式碼（註解為 `// 3. Check if user's email is in the whitelist` 的區塊）。
    2.  將整個區塊**刪除或註解掉**。這樣一來，函式收到指令後，只會驗證 JWT (使用者是否登入)，然後就直接去發布 MQTT 指令，從而達到加速操作的目的。

---

### **針對需求 2：開放白名單的查詢權限**

這個需求只需要修改資料庫的安全規則 (RLS Policies)。

*   **目前的邏輯**：
    1.  管理員可以讀取**所有**資料。
    2.  一般登入者只能讀取**自己的那筆**資料。
*   **要修改成的邏輯**：
    1.  **寫入權限（新增/刪除/修改）不變**：維持只有管理員能操作。
    2.  **讀取權限**：開放給**任何已登入的使用者 (`authenticated`)**，讓他們可以查詢完整的白名單列表。

*   **需要修改的檔案**： `supabase/migrations/20251016142044_remote_schema.sql`
*   **具體作法**：
    1.  找到名為 `Allow authenticated to read own entry` 的 `select` 策略。
    2.  將它的 `using` 條件從 `(email = auth.email())` 修改為 `(auth.role() = 'authenticated')`。
    3.  這樣一來，只要是登入的使用者，`SELECT` 查詢就會被允許，滿足了前端在登入後需要立即驗證的需求。
    4.  其他的 `insert`, `update`, `delete` 策略都維持原樣，確保只有管理員能修改資料。

---

### **總結**

總結來說，您需要進行以下三項核心改動：

1.  **`script.js`**：增加登入成功後的白名單檢查邏輯。
2.  **`control-door/index.ts`**：移除 API 被呼叫時的重複白名單檢查。
3.  **`..._remote_schema.sql`**：放寬 `whitelist` 資料表的讀取權限給所有登入者。

以上是完整的修改計畫。如果您確認沒有問題，我就可以開始為您產生修改後的程式碼。



3.  **`..._remote_schema.sql`**：放寬 `whitelist` 資料表的讀取權限給所有登入者。

以上是完整的修改計畫。如果您確認沒有問題，我就可以開始為您產生修改後的程式碼。
